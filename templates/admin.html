<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Lab Access</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <nav class="admin-header">
        <div class="flex items-center gap-2">
            <span style="font-size: 24px;" role="img">üìä</span>
            <div>
                <div class="font-bold" style="font-size: 1.1rem; color: var(--primary-dark);">Lab Monitor</div>
                <div style="font-size: 0.8rem; color: var(--text-light);">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.location.reload()" class="btn btn-outline">üîÑ Refresh</button>
            <a href="{{ url_for('index') }}" class="btn btn-primary" style="text-decoration: none;">üè† ‡∏´‡∏ô‡πâ‡∏≤ Check-in</a>
        </div>
    </nav>

    <div class="admin-container">

        <!-- TAB MENU -->
        <div class="admin-tabs" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button id="tabBtnMonitor" class="btn btn-primary" onclick="switchAdminTab('monitor')">üì° Monitor (Real-time)</button>
            <button id="tabBtnReport" class="btn btn-outline" onclick="switchAdminTab('report')">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Report)</button>
        </div>
        
        <!-- ============================================= -->
        <!-- VIEW 1: MONITOR (REAL-TIME) -->
        <!-- ============================================= -->
        <div id="viewMonitor">
            
            <!-- Header Controls -->
            <div class="flex justify-end mb-4">
                <div class="view-switcher">
                    <button id="btnViewTable" class="view-btn active" onclick="switchMonitorView('table')">üìÑ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Table)</button>
                    <button id="btnViewMap" class="view-btn" onclick="switchMonitorView('map')">üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á (Map)</button>
                </div>
            </div>
            
            <!-- üåü Status Cards (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠) -->
            <div class="dashboard-grid">
                <div class="stat-card" style="border-left: 4px solid var(--success);">
                    <span class="stat-label">üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active)</span>
                    <span class="stat-value" id="statActive">0</span>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--primary);">
                    <span class="stat-label">üìÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)</span>
                    <span class="stat-value" id="statToday">0</span>
                </div>
                <!-- Hidden Student Stat -->
                <span id="statStudent" style="display: none;"></span>
                
                <div class="stat-card" style="border-left: 4px solid var(--warning);">
                    <span class="stat-label">üíª ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ß‡πà‡∏≤‡∏á (Available)</span>
                    <span class="stat-value" id="statSeats">60/60</span>
                </div>
            </div>

            <!-- 1.1 TABLE VIEW WRAPPER -->
            <div id="monitorTableViewWrapper">
                <div class="filter-wrapper">
                   <div class="flex flex-wrap justify-between items-center gap-2">
                       <div class="flex items-center gap-2">
                            <span class="font-bold text-main">Filter:</span>
                            <select id="timeFilter" class="filter-select" onchange="renderMonitorData()">
                                <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                                <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                            </select>
                       </div>
                       <div class="search-box">
                           <span class="search-icon">üîç</span>
                           <input type="text" id="searchInput" onkeyup="renderMonitorData()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤...">
                       </div>
                       <button onclick="exportCSV()" class="btn btn-primary btn-sm">üì• CSV</button>
                   </div>
                   
                   <!-- Advanced Filter Row -->
                    <div class="filter-row">
                        <div class="filter-group"><span class="filter-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span><select id="typeFilter" class="filter-select" onchange="renderMonitorData()"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option><option value="student">üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option><option value="teacher">üë®‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option><option value="staff">üè¢ ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option><option value="guest">üë§ ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option></select></div>
                        <div class="filter-group"><span class="filter-label">‡∏Ñ‡∏ì‡∏∞/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</span><select id="facultyFilter" class="filter-select" onchange="renderMonitorData()"><option value="all">üè¢ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ì‡∏∞</option></select></div>
                        <div class="filter-group"><span class="filter-label">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</span><select id="yearFilter" class="filter-select" onchange="renderMonitorData()"><option value="all">üéì ‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option></select></div>
                        <div class="filter-group"><span class="filter-label">‡πÇ‡∏ã‡∏ô</span><select id="zoneFilter" class="filter-select" onchange="renderMonitorData()"><option value="all">ü™ë ‡∏ó‡∏∏‡∏Å‡πÇ‡∏ã‡∏ô</option></select></div>
                        <div class="filter-group"><span class="filter-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><select id="statusFilter" class="filter-select" onchange="renderMonitorData()"><option value="active">üü¢ Active Only</option><option value="completed">‚ö™ Completed</option><option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div>
                        <button onclick="resetFilters()" class="btn btn-outline btn-sm" style="height: 38px; align-self: flex-end;">‚ùå Reset</button>
                    </div>
                </div>

                <div id="monitorTableView" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="handleSort('checkIn')">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                                <th class="sortable" onclick="handleSort('name')">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏Ñ‡∏ì‡∏∞</th>
                                <th>‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</th>
                                <th>‡πÇ‡∏ï‡πä‡∏∞</th>
                                <th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 1.2 MAP VIEW -->
            <div id="monitorMapView" class="hidden">
                
                <!-- Config Dropdown -->
                <details class="mb-4 p-3 border rounded-lg bg-white shadow-sm">
                    <summary class="font-bold text-primary cursor-pointer list-none flex items-center gap-2">
                        <span>‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á & Master List (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î)</span>
                    </summary>
                    
                    <div class="mt-4" style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- Zone Config -->
                        <div style="flex: 1; min-width: 300px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                            <h4 class="font-bold text-main mb-2 text-sm">üó∫Ô∏è ‡πÇ‡∏ã‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏ï‡πä‡∏∞</h4>
                            <div id="zoneConfigContainer" class="mb-3"></div>
                            <div class="flex gap-2">
                                <input type="text" id="newZoneName" class="input-field" placeholder="‡πÇ‡∏ã‡∏ô (‡πÄ‡∏ä‡πà‡∏ô D)" style="margin:0; flex:1; padding:8px;">
                                <input type="number" id="newZoneCount" class="input-field" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" style="margin:0; width:80px; padding:8px;">
                                <button onclick="addZone()" class="btn btn-primary btn-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                        </div>

                        <!-- Software Config -->
                        <div style="flex: 1; min-width: 300px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                            <h4 class="font-bold text-main mb-2 text-sm">ü§ñ Master List: ‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå & AI</h4>
                            <div id="softwareListContainer" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;"></div>
                            <div class="flex gap-2">
                                <input type="text" id="newSoftwareName" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠ AI (‡πÄ‡∏ä‡πà‡∏ô Claude)" style="margin:0; padding:8px;">
                                <button onclick="addSoftware()" class="btn btn-primary btn-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Map Controls -->
                <div class="map-controls" style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div class="text-sm text-light">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠ Check-out</div>
                    <div class="map-legend">
                        <div class="legend-item"><div class="legend-box" style="background:#fff; border:2px solid #e2e8f0;"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
                        <div class="legend-item"><div class="legend-box" style="background:#f0fdf4; border:2px solid #16a34a;"></div> ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                        <div class="legend-item"><div class="legend-box" style="background:#fef2f2; border:2px solid #ef4444;"></div> ‡∏õ‡∏¥‡∏î‡∏ã‡πà‡∏≠‡∏°</div>
                    </div>
                </div>
                
                <div id="deskMapContainer"></div>
            </div>

            <div id="noDataMessage" class="hidden text-center mt-4 text-light">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        </div>

        <!-- VIEW 2: REPORT -->
        <div id="viewReport" class="hidden">
             <div class="filter-bar">
                 <div class="flex items-center gap-2 flex-wrap">
                     <span class="font-bold text-main">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span>
                     <select id="reportType" class="filter-select" onchange="updateReport()">
                         <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily)</option>
                         <option value="monthly" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly)</option>
                         <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Yearly)</option>
                     </select>
                     <input type="date" id="reportDate" class="filter-select" onchange="updateReport()">
                     <button onclick="exportReportCSV()" class="btn btn-primary" style="padding: 8px 16px;">üì• Export CSV</button>
                 </div>
             </div>

             <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 2rem;">
                 <div class="chart-wrapper" style="flex: 2; min-width: 300px;">
                     <h4 class="text-center mb-2 font-bold text-main">üìà ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Usage Volume)</h4>
                     <canvas id="usageChart"></canvas>
                 </div>
                 <div class="chart-wrapper" style="flex: 1; min-width: 300px;">
                     <h4 class="text-center mb-2 font-bold text-main">üèÜ AI ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (Top AI Tools)</h4>
                     <canvas id="aiChart"></canvas>
                 </div>
             </div>

             <!-- Summary Stats -->
             <div class="dashboard-grid">
                 <div class="stat-card">
                     <span class="stat-label">üë• ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                     <span class="stat-value" id="repTotalUsers">0</span>
                 </div>
                 <div class="stat-card">
                     <span class="stat-label">üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
                     <span class="stat-value" id="repStudentCount">0</span>
                 </div>
                 <div class="stat-card" style="border-left: 4px solid #f97316;">
                     <span class="stat-label">‚è±Ô∏è ‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î</span>
                     <span class="stat-value" style="font-size: 1.5rem;" id="repMaxDuration">-</span>
                     <span style="font-size: 0.8rem; color: #666;" id="repMaxUser"></span>
                 </div>
                 <div class="stat-card" style="border-left: 4px solid #8b5cf6;">
                     <span class="stat-label">ü§ñ ‡πÉ‡∏ä‡πâ AI</span>
                     <span class="stat-value" id="repAICount">0</span>
                 </div>
             </div>
        </div>

    </div>

    <!-- MODAL: DESK MANAGEMENT -->
    <div id="deskModal" class="modal-overlay">
        <div class="modal-content" style="text-align: left; max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-main" style="font-size: 1.2rem;">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ <span id="modalDeskId" style="color:var(--primary);"></span></h3>
                <button onclick="closeDeskModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666;">&times;</button>
            </div>
            
            <div class="mb-4">
                <label class="filter-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞</label>
                <select id="deskStatusSelect" class="input-field" style="padding: 8px; width: 100%; background: white;">
                    <option value="available">‚úÖ ‡∏ß‡πà‡∏≤‡∏á (Available)</option>
                    <option value="maintenance">üîß ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (Maintenance)</option>
                    <option value="occupied" disabled>üë§ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (Occupied)</option>
                </select>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
            <div id="userInfoSection" class="mb-4 hidden" style="background: #f0fdf4; padding: 12px; border-radius: 8px; border: 1px solid #bbf7d0;">
                 <p class="text-sm text-light">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</p>
                 <p class="font-bold" style="color: #166534; font-size: 1.1rem;" id="modalUserDisplay">-</p>
                 <div class="flex justify-between items-end mt-2">
                    <p class="text-sm text-light">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="modalTimeDisplay">-</span></p>
                    <button id="btnForceCheckout" class="btn btn-sm btn-outline" style="color: var(--danger); border-color: var(--danger);">
                        Check-out ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ
                    </button>
                 </div>
            </div>

            <div class="mb-4">
                <label class="filter-label">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå / AI (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Master List)</label>
                <!-- Checkbox Container -->
                <div id="modalSoftwareCheckboxes" class="checkbox-grid-container"></div>
            </div>

            <button onclick="saveDeskDetails()" class="btn btn-primary w-full justify-center">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>